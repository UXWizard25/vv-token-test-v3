name: Auto PR from Figma Tokens

# Trigger: Wenn Variable Visualizer Plugin zu figma-tokens Branch pusht
on:
  push:
    branches:
      - figma-tokens
    paths:
      - 'packages/tokens/src/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-create-pr:
    name: Build Tokens & Create PR
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: figma-tokens
          fetch-depth: 0

      # 2. Node.js Setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. Dependencies installieren
      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci

      # 4. Build neue Tokens (PR Branch)
      - name: Build New Tokens
        id: build
        run: |
          echo "ğŸ¨ Building design tokens (new version)..."
          npm run build 2>&1 | tee build-output.log

          # Extrahiere Build-Statistiken
          SUCCESSFUL_BUILDS=$(grep -oP 'Builds erfolgreich: \K\d+' build-output.log || echo "0")
          TOTAL_BUILDS=$(grep -oP 'Builds erfolgreich: \d+/\K\d+' build-output.log || echo "0")

          echo "successful_builds=$SUCCESSFUL_BUILDS" >> $GITHUB_OUTPUT
          echo "total_builds=$TOTAL_BUILDS" >> $GITHUB_OUTPUT

          if [ "$SUCCESSFUL_BUILDS" -eq "0" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi

          echo "âœ… Build successful: $SUCCESSFUL_BUILDS/$TOTAL_BUILDS"

      # 5. Build Baseline (Main Branch) fÃ¼r Vergleich
      - name: Build Baseline for Comparison
        id: baseline
        run: |
          echo "ğŸ“¦ Building baseline from main branch for full dist/ comparison..."

          # === DEBUG: Zeige Status vor dem Sichern ===
          echo "ğŸ“‚ Current state before saving:"
          echo "  .tokens/ exists: $([ -d packages/tokens/.tokens ] && echo 'yes' || echo 'no')"
          echo "  dist/ exists: $([ -d packages/tokens/dist ] && echo 'yes' || echo 'no')"
          echo "  dist/ files: $(find packages/tokens/dist -type f 2>/dev/null | wc -l)"

          # Sichere neue Builds
          mv packages/tokens/.tokens/ tokens-new/
          mv packages/tokens/dist/ dist-new/

          echo "ğŸ“‚ After saving new builds:"
          echo "  tokens-new/ files: $(find tokens-new -type f 2>/dev/null | wc -l)"
          echo "  dist-new/ files: $(find dist-new -type f 2>/dev/null | wc -l)"

          # Sichere neue Source-Datei
          cp packages/tokens/src/bild-design-system-raw-data.json /tmp/new-source.json
          echo "  new-source.json: $(ls -la /tmp/new-source.json | awk '{print $5}') bytes"

          # Hole Source von main Branch
          git fetch origin main
          echo ""
          echo "ğŸ” Fetching main branch source..."

          if git show origin/main:packages/tokens/src/bild-design-system-raw-data.json > /tmp/old-source.json 2>/dev/null; then
            echo "âœ… Main branch source loaded: $(ls -la /tmp/old-source.json | awk '{print $5}') bytes"

            # PrÃ¼fe ob Source-Dateien unterschiedlich sind
            if diff -q /tmp/old-source.json /tmp/new-source.json > /dev/null 2>&1; then
              echo "âš ï¸ WARNING: Source files are IDENTICAL! No token changes expected."
            else
              echo "âœ… Source files differ - token changes expected"
            fi

            # Kopiere main source fÃ¼r Build
            cp /tmp/old-source.json packages/tokens/src/bild-design-system-raw-data.json

            # Build mit main Source
            echo ""
            echo "ğŸ”¨ Building baseline tokens..."
            if npm run build:tokens 2>&1; then
              echo "âœ… Baseline build succeeded"
            else
              echo "âŒ Baseline build FAILED"
            fi

            # Verschiebe zu dist-old fÃ¼r Vergleich
            if [ -d "packages/tokens/dist" ]; then
              echo "ğŸ“‚ Baseline dist/ created with $(find packages/tokens/dist -type f | wc -l) files"
              mv packages/tokens/dist/ dist-old/
              echo "baseline_available=true" >> $GITHUB_OUTPUT
              echo "source_available=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ ERROR: Baseline dist/ was NOT created!"
              mkdir -p dist-old
              echo "baseline_available=false" >> $GITHUB_OUTPUT
              echo "source_available=false" >> $GITHUB_OUTPUT
            fi

            # AufrÃ¤umen
            rm -rf packages/tokens/.tokens/
          else
            echo "âš ï¸ No main branch source found (first PR?)"
            mkdir -p dist-old
            echo "baseline_available=false" >> $GITHUB_OUTPUT
            echo "source_available=false" >> $GITHUB_OUTPUT
          fi

          # Stelle neue Source und Builds wieder her
          mv /tmp/new-source.json packages/tokens/src/bild-design-system-raw-data.json
          mkdir -p packages/tokens
          mv tokens-new/ packages/tokens/.tokens/
          mv dist-new/ packages/tokens/dist/

          echo ""
          echo "âœ… Baseline comparison ready"
          echo "ğŸ“ Final state:"
          echo "   dist-old/ files: $(find dist-old -type f 2>/dev/null | wc -l)"
          echo "   packages/tokens/dist/ files: $(find packages/tokens/dist -type f 2>/dev/null | wc -l)"

      # 6. Vergleiche Dist Builds (alle Plattformen)
      - name: Compare Dist Builds
        id: diff
        run: |
          echo "ğŸ” Comparing full dist/ builds across all platforms..."

          # === DEBUGGING: Zeige Verzeichnisinhalte ===
          echo ""
          echo "ğŸ“‚ DEBUG: Directory contents"
          echo "=== dist-old/ ==="
          ls -la dist-old/ 2>/dev/null | head -10 || echo "  (empty or not found)"
          echo "  Total files: $(find dist-old/ -type f 2>/dev/null | wc -l)"

          echo "=== packages/tokens/dist/ ==="
          ls -la packages/tokens/dist/ 2>/dev/null | head -10 || echo "  (empty or not found)"
          echo "  Total files: $(find packages/tokens/dist/ -type f 2>/dev/null | wc -l)"

          echo "=== Source files ==="
          echo "  /tmp/old-source.json: $(ls -la /tmp/old-source.json 2>/dev/null | awk '{print $5}' || echo 'not found') bytes"
          echo "  new source: $(ls -la packages/tokens/src/bild-design-system-raw-data.json 2>/dev/null | awk '{print $5}' || echo 'not found') bytes"
          echo ""

          # === Workflow Output Status ===
          echo "ğŸ“‹ Workflow outputs:"
          echo "  baseline_available: ${{ steps.baseline.outputs.baseline_available }}"
          echo "  source_available: ${{ steps.baseline.outputs.source_available }}"
          echo ""

          # Warnung wenn keine Baseline vorhanden
          if [ "${{ steps.baseline.outputs.baseline_available }}" == "false" ]; then
            echo "âš ï¸ WARNING: No baseline found in main branch!"
            echo "   All tokens will be shown as 'Added' in the diff."
            echo "   This can happen when:"
            echo "   - This is the first PR (no previous tokens exist)"
            echo "   - The source file was deleted in main"
            echo ""
          fi

          # FÃ¼hre Vergleich mit Source-Dateien fÃ¼r Rename-Erkennung durch
          echo "ğŸ”§ Running compare-builds.js..."
          if [ "${{ steps.baseline.outputs.source_available }}" == "true" ]; then
            echo "  â†’ With source files for rename detection"
            node scripts/tokens/compare-builds.js \
              --old dist-old/ \
              --new packages/tokens/dist/ \
              --source-old /tmp/old-source.json \
              --source-new packages/tokens/src/bild-design-system-raw-data.json \
              --output dist-diff.json
          else
            echo "  â†’ Without source files (no rename detection)"
            node scripts/tokens/compare-builds.js \
              --old dist-old/ \
              --new packages/tokens/dist/ \
              --output dist-diff.json
          fi

          # Extrahiere Summary fÃ¼r Output
          if [ -f "dist-diff.json" ]; then
            echo ""
            echo "ğŸ“Š dist-diff.json created successfully"

            ADDED=$(cat dist-diff.json | jq -r '.summary.tokensAdded // 0')
            MODIFIED=$(cat dist-diff.json | jq -r '.summary.tokensModified // 0')
            DELETED=$(cat dist-diff.json | jq -r '.summary.tokensRemoved // 0')
            IMPACT=$(cat dist-diff.json | jq -r '.summary.impactLevel // "unknown"')
            FILES_CHANGED=$(cat dist-diff.json | jq -r '(.summary.filesAdded + .summary.filesModified + .summary.filesRemoved) // 0')
            UNIQUE_ADDED=$(cat dist-diff.json | jq -r '.summary.uniqueTokensAdded // 0')
            UNIQUE_MODIFIED=$(cat dist-diff.json | jq -r '.summary.uniqueTokensModified // 0')
            UNIQUE_REMOVED=$(cat dist-diff.json | jq -r '.summary.uniqueTokensRemoved // 0')

            # Unique counts (for Build Summary)
            UNIQUE_RENAMED=$(cat dist-diff.json | jq -r '.summary.uniqueTokensRenamed // 0')
            BREAKING_REMOVED=$(cat dist-diff.json | jq -r '.grouped.counts.breakingRemoved // 0')
            BREAKING_RENAMED=$(cat dist-diff.json | jq -r '.grouped.counts.breakingRenamed // 0')

            echo "added=$ADDED" >> $GITHUB_OUTPUT
            echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
            echo "deleted=$DELETED" >> $GITHUB_OUTPUT
            echo "impact=$IMPACT" >> $GITHUB_OUTPUT
            echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
            echo "unique_added=$UNIQUE_ADDED" >> $GITHUB_OUTPUT
            echo "unique_modified=$UNIQUE_MODIFIED" >> $GITHUB_OUTPUT
            echo "unique_removed=$UNIQUE_REMOVED" >> $GITHUB_OUTPUT
            echo "unique_renamed=$UNIQUE_RENAMED" >> $GITHUB_OUTPUT
            echo "breaking_removed=$BREAKING_REMOVED" >> $GITHUB_OUTPUT
            echo "breaking_renamed=$BREAKING_RENAMED" >> $GITHUB_OUTPUT

            echo ""
            echo "ğŸ“Š Diff Summary:"
            echo "   Platform occurrences: +$ADDED | ~$MODIFIED | -$DELETED"
            echo "   Unique tokens: +$UNIQUE_ADDED | ~$UNIQUE_MODIFIED | -$UNIQUE_REMOVED | â†”$UNIQUE_RENAMED"
            echo "   Breaking: $BREAKING_REMOVED removed, $BREAKING_RENAMED renamed"
            echo "   Files changed: $FILES_CHANGED"
            echo "   Impact level: $IMPACT"
          else
            echo "âŒ ERROR: dist-diff.json was not created!"
          fi

      # 7. Upload Build Artifacts
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: figma-tokens-${{ github.sha }}
          path: |
            packages/tokens/dist/
            packages/tokens/.tokens/
            dist-diff.json
            build-output.log
          retention-days: 30

      # 8. PrÃ¼fe ob PR bereits existiert
      - name: Check for Existing PR
        id: check_pr
        run: |
          PR_NUMBER=$(gh pr list --base main --head figma-tokens --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$PR_NUMBER"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. Generate Release Notes
      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "ğŸ“ Generating platform-specific release notes..."

          # Debug: Zeige diff.json Summary
          if [ -f "dist-diff.json" ]; then
            echo "ğŸ“Š Diff Summary from JSON:"
            cat dist-diff.json | jq -r '.summary | "  Added: \(.tokensAdded // 0), Modified: \(.tokensModified // 0), Removed: \(.tokensRemoved // 0), Impact: \(.impactLevel // "unknown")"'
            echo "  Renames: $(cat dist-diff.json | jq -r '.renames | length // 0')"
            echo "  Style Renames: $(cat dist-diff.json | jq -r '.styleRenames | length // 0')"
          else
            echo "âš ï¸ dist-diff.json not found!"
          fi

          # Generate release notes mit Dist-Diff-Datei
          node scripts/tokens/release-notes.js \
            --diff-file "dist-diff.json" \
            --format "pr-comment" \
            --commit-sha "${{ github.sha }}" \
            --build-success true \
            --successful-builds "${{ steps.build.outputs.successful_builds }}" \
            --total-builds "${{ steps.build.outputs.total_builds }}" \
            --run-id "${{ github.run_id }}" \
            --no-baseline "${{ steps.baseline.outputs.baseline_available == 'false' }}" > release-notes.md

          # Debug: Zeige Release Notes LÃ¤nge
          echo "ğŸ“ Release notes generated: $(wc -l < release-notes.md) lines, $(wc -c < release-notes.md) bytes"

          echo "âœ… Release notes generated successfully"

      # 10. Erstelle oder Update Pull Request
      - name: Create or Update Pull Request
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "ğŸ“ Updating existing PR #${{ steps.check_pr.outputs.pr_number }}..."

            # Update PR body with new release notes
            gh pr edit ${{ steps.check_pr.outputs.pr_number }} --body-file release-notes.md

            # Add comment with update summary
            IMPACT="${{ steps.diff.outputs.impact }}"
            ADDED="${{ steps.diff.outputs.added }}"
            MODIFIED="${{ steps.diff.outputs.modified }}"
            DELETED="${{ steps.diff.outputs.deleted }}"

            if [ "$IMPACT" == "breaking" ]; then
              EMOJI="ğŸ”´"
            elif [ "$IMPACT" == "moderate" ]; then
              EMOJI="ğŸŸ¡"
            else
              EMOJI="ğŸŸ¢"
            fi

            echo "## ${EMOJI} Token Update" > /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "**Changes:** +${ADDED} | ~${MODIFIED} | -${DELETED}" >> /tmp/pr-comment.md
            echo "**Build:** âœ… ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }}" >> /tmp/pr-comment.md
            echo "**Commit:** \`${{ github.sha }}\`" >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "PR description updated with full release notes." >> /tmp/pr-comment.md

            gh pr comment ${{ steps.check_pr.outputs.pr_number }} --body-file /tmp/pr-comment.md

          else
            echo "ğŸ“ Creating new Pull Request..."

            # Create PR with generated release notes
            gh pr create \
              --base main \
              --head figma-tokens \
              --title "ğŸ¨ Update design tokens from Figma" \
              --body-file release-notes.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. Build Summary erstellen
      - name: Create Build Summary
        run: |
          IMPACT="${{ steps.diff.outputs.impact }}"
          UNIQUE_ADDED="${{ steps.diff.outputs.unique_added }}"
          UNIQUE_MODIFIED="${{ steps.diff.outputs.unique_modified }}"
          UNIQUE_REMOVED="${{ steps.diff.outputs.unique_removed }}"
          UNIQUE_RENAMED="${{ steps.diff.outputs.unique_renamed }}"
          BREAKING_REMOVED="${{ steps.diff.outputs.breaking_removed }}"
          BREAKING_RENAMED="${{ steps.diff.outputs.breaking_renamed }}"

          # Header with impact level
          if [ "$IMPACT" == "breaking" ]; then
            echo "## ğŸ¨ Design Tokens Â· ğŸ”´ Breaking" >> $GITHUB_STEP_SUMMARY
          elif [ "$IMPACT" == "moderate" ]; then
            echo "## ğŸ¨ Design Tokens Â· ğŸŸ¡ Visual Changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸ¨ Design Tokens Â· ğŸŸ¢ Minor" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Token counts table (unique tokens)
          if [ "$UNIQUE_RENAMED" != "0" ] && [ -n "$UNIQUE_RENAMED" ]; then
            echo "| Added | Modified | Removed | Renamed |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|---------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| $UNIQUE_ADDED | $UNIQUE_MODIFIED | $UNIQUE_REMOVED | $UNIQUE_RENAMED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Added | Modified | Removed |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| $UNIQUE_ADDED | $UNIQUE_MODIFIED | $UNIQUE_REMOVED |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Breaking changes detail (if any)
          if [ "$IMPACT" == "breaking" ]; then
            echo "âš ï¸ **Breaking:** $BREAKING_REMOVED removed, $BREAKING_RENAMED renamed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No breaking changes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build status
          echo "**Build:** âœ… ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }} platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # PR info
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "**Pull Request:** Updated PR #${{ steps.check_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Pull Request:** New PR created" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY

          # Context-aware next steps
          if [ "$IMPACT" == "breaking" ]; then
            echo "1. âš ï¸ Review breaking changes in PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Check renamed tokens for migration" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge to publish" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. Review the Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge to publish" >> $GITHUB_STEP_SUMMARY
          fi

      # 12. Bei Fehler benachrichtigen
      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Design Token Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`figma-tokens\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -50 build-output.log 2>/dev/null || echo "No build log available"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
