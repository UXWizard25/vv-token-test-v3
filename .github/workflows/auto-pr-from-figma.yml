name: Auto PR from Figma Tokens

# Trigger: Wenn Variable Visualizer Plugin zu figma-tokens Branch pusht
on:
  push:
    branches:
      - figma-tokens
    paths:
      - 'src/design-tokens/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-create-pr:
    name: Build Tokens & Create PR
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: figma-tokens
          fetch-depth: 0

      # 2. Node.js Setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Dependencies installieren
      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci

      # 4. Build neue Tokens (PR Branch)
      - name: Build New Tokens
        id: build
        run: |
          echo "ðŸŽ¨ Building design tokens (new version)..."
          npm run build 2>&1 | tee build-output.log

          # Extrahiere Build-Statistiken
          SUCCESSFUL_BUILDS=$(grep -oP 'Builds erfolgreich: \K\d+' build-output.log || echo "0")
          TOTAL_BUILDS=$(grep -oP 'Builds erfolgreich: \d+/\K\d+' build-output.log || echo "0")

          echo "successful_builds=$SUCCESSFUL_BUILDS" >> $GITHUB_OUTPUT
          echo "total_builds=$TOTAL_BUILDS" >> $GITHUB_OUTPUT

          if [ "$SUCCESSFUL_BUILDS" -eq "0" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi

          echo "âœ… Build successful: $SUCCESSFUL_BUILDS/$TOTAL_BUILDS"

      # 5. Build Baseline (Main Branch) fÃ¼r Vergleich
      - name: Build Baseline for Comparison
        id: baseline
        run: |
          echo "ðŸ“¦ Building baseline from main branch for full dist/ comparison..."

          # Sichere neue Builds
          mv tokens/ tokens-new/
          mv dist/ dist-new/

          # Sichere neue Source-Datei
          cp src/design-tokens/bild-design-system-raw-data.json /tmp/new-source.json

          # Hole Source von main Branch
          git fetch origin main
          if git show origin/main:src/design-tokens/bild-design-system-raw-data.json > src/design-tokens/bild-design-system-raw-data.json 2>/dev/null; then
            echo "âœ… Main branch source loaded"

            # Build mit main Source
            npm run build 2>&1 || echo "Baseline build completed"

            # Verschiebe zu dist-old fÃ¼r Vergleich
            if [ -d "dist" ]; then
              mv dist/ dist-old/
              echo "baseline_available=true" >> $GITHUB_OUTPUT
            else
              mkdir -p dist-old
              echo "baseline_available=false" >> $GITHUB_OUTPUT
            fi

            # AufrÃ¤umen
            rm -rf tokens/
          else
            echo "âš ï¸ No main branch source found (first PR?)"
            mkdir -p dist-old
            echo "baseline_available=false" >> $GITHUB_OUTPUT
          fi

          # Stelle neue Source und Builds wieder her
          mv /tmp/new-source.json src/design-tokens/bild-design-system-raw-data.json
          mv tokens-new/ tokens/
          mv dist-new/ dist/

          echo "âœ… Baseline comparison ready"
          echo "ðŸ“ dist-old/ = main branch, dist/ = new version"

      # 6. Vergleiche Dist Builds (alle Plattformen)
      - name: Compare Dist Builds
        id: diff
        run: |
          echo "ðŸ” Comparing full dist/ builds across all platforms..."

          node scripts/compare-dist-builds.js \
            --old dist-old/ \
            --new dist/ \
            --output dist-diff.json

          # Extrahiere Summary fÃ¼r Output
          if [ -f "dist-diff.json" ]; then
            ADDED=$(cat dist-diff.json | jq -r '.summary.tokensAdded // 0')
            MODIFIED=$(cat dist-diff.json | jq -r '.summary.tokensModified // 0')
            DELETED=$(cat dist-diff.json | jq -r '.summary.tokensRemoved // 0')
            IMPACT=$(cat dist-diff.json | jq -r '.summary.impactLevel // "unknown"')
            FILES_CHANGED=$(cat dist-diff.json | jq -r '(.summary.filesAdded + .summary.filesModified + .summary.filesRemoved) // 0')

            echo "added=$ADDED" >> $GITHUB_OUTPUT
            echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
            echo "deleted=$DELETED" >> $GITHUB_OUTPUT
            echo "impact=$IMPACT" >> $GITHUB_OUTPUT
            echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

            echo "ðŸ“Š Diff Summary: +$ADDED | ~$MODIFIED | -$DELETED tokens (Impact: $IMPACT)"
            echo "ðŸ“ Files changed: $FILES_CHANGED"
          fi

      # 7. Upload Build Artifacts
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: figma-tokens-${{ github.sha }}
          path: |
            dist/
            tokens/
            dist-diff.json
            build-output.log
          retention-days: 30

      # 8. PrÃ¼fe ob PR bereits existiert
      - name: Check for Existing PR
        id: check_pr
        run: |
          PR_NUMBER=$(gh pr list --base main --head figma-tokens --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$PR_NUMBER"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. Generate Release Notes
      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "ðŸ“ Generating platform-specific release notes..."

          # Generate release notes mit Dist-Diff-Datei
          node scripts/generate-release-notes.js \
            --diff-file "dist-diff.json" \
            --format "pr-comment" \
            --commit-sha "${{ github.sha }}" \
            --build-success true \
            --successful-builds "${{ steps.build.outputs.successful_builds }}" \
            --total-builds "${{ steps.build.outputs.total_builds }}" \
            --run-id "${{ github.run_id }}" > release-notes.md

          echo "âœ… Release notes generated successfully"

      # 10. Erstelle oder Update Pull Request
      - name: Create or Update Pull Request
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "ðŸ“ Updating existing PR #${{ steps.check_pr.outputs.pr_number }}..."

            # Update PR body with new release notes
            gh pr edit ${{ steps.check_pr.outputs.pr_number }} --body-file release-notes.md

            # Add comment with update summary
            IMPACT="${{ steps.diff.outputs.impact }}"
            ADDED="${{ steps.diff.outputs.added }}"
            MODIFIED="${{ steps.diff.outputs.modified }}"
            DELETED="${{ steps.diff.outputs.deleted }}"

            if [ "$IMPACT" == "breaking" ]; then
              EMOJI="ðŸ”´"
            elif [ "$IMPACT" == "moderate" ]; then
              EMOJI="ðŸŸ¡"
            else
              EMOJI="ðŸŸ¢"
            fi

            echo "## ${EMOJI} Token Update" > /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "**Changes:** +${ADDED} | ~${MODIFIED} | -${DELETED}" >> /tmp/pr-comment.md
            echo "**Build:** âœ… ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }}" >> /tmp/pr-comment.md
            echo "**Commit:** \`${{ github.sha }}\`" >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "PR description updated with full release notes." >> /tmp/pr-comment.md

            gh pr comment ${{ steps.check_pr.outputs.pr_number }} --body-file /tmp/pr-comment.md

          else
            echo "ðŸ“ Creating new Pull Request..."

            # Create PR with generated release notes
            gh pr create \
              --base main \
              --head figma-tokens \
              --title "ðŸŽ¨ Update design tokens from Figma" \
              --body-file release-notes.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. Build Summary erstellen
      - name: Create Build Summary
        run: |
          echo "## ðŸŽ¨ Design Token Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IMPACT="${{ steps.diff.outputs.impact }}"
          if [ "$IMPACT" == "breaking" ]; then
            echo "### ðŸ”´ Breaking Changes Detected!" >> $GITHUB_STEP_SUMMARY
          elif [ "$IMPACT" == "moderate" ]; then
            echo "### ðŸŸ¡ Moderate Update" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸŸ¢ Minor Update" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Token Changes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Added: ${{ steps.diff.outputs.added }}" >> $GITHUB_STEP_SUMMARY
          echo "- Modified: ${{ steps.diff.outputs.modified }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted: ${{ steps.diff.outputs.deleted }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** âœ… ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "**Pull Request:** Updated PR #${{ steps.check_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Pull Request:** New PR created" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the token changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge the PR to publish package" >> $GITHUB_STEP_SUMMARY

      # 12. Bei Fehler benachrichtigen
      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Design Token Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`figma-tokens\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -50 build-output.log 2>/dev/null || echo "No build log available"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
