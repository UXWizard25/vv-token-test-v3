# ============================================================================
# Auto PR from Figma Icons
# ============================================================================
#
# Automatically creates/updates a PR when the Figma plugin pushes
# icon changes to the figma-icons branch.
#
# Workflow:
#   1. Figma plugin pushes SVGs to figma-icons branch
#   2. This workflow builds icons for all platforms
#   3. Commits generated files back to figma-icons
#   4. Creates or updates PR to main with release notes
#
# ============================================================================

name: Auto PR from Figma Icons

on:
  push:
    branches:
      - figma-icons
    paths:
      - 'packages/icons/src/**'

# Prevent concurrent runs
concurrency:
  group: figma-icons-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-pr:
    name: Build Icons & Create PR
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # Setup
      # ========================================

      - name: Checkout figma-icons branch
        uses: actions/checkout@v4
        with:
          ref: figma-icons
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install svgo@^3.2.0 @svgr/core@^8.1.0 svg2vectordrawable@^2.9.1 typescript@^5.3.0 @types/react@^18.2.0

      # ========================================
      # Baseline (from main)
      # ========================================

      - name: Get baseline from main
        run: |
          echo "::group::Fetching baseline from main"

          # Create temp directory for baseline
          mkdir -p dist-icons-old

          # Try to get existing icons from main
          git fetch origin main:refs/remotes/origin/main || true

          if git show origin/main:packages/icons/dist/svg 2>/dev/null; then
            git checkout origin/main -- packages/icons/dist || true
            if [ -d "packages/icons/dist" ]; then
              cp -r packages/icons/dist/* dist-icons-old/ 2>/dev/null || true
              rm -rf packages/icons/dist
            fi
          fi

          echo "::endgroup::"

      # ========================================
      # Build New Icons
      # ========================================

      - name: Build icons
        run: |
          echo "::group::Building icon assets"
          node scripts/icons/build-icons.js
          echo "::endgroup::"

      # ========================================
      # Compare & Generate Release Notes
      # ========================================

      - name: Compare builds
        id: compare
        run: |
          echo "::group::Comparing builds"
          node scripts/icons/compare-icon-builds.js dist-icons-old packages/icons/dist
          echo "::endgroup::"

          # Read summary from diff
          if [ -f "icons-diff.json" ]; then
            ADDED=$(cat icons-diff.json | grep -o '"added":[0-9]*' | head -1 | cut -d: -f2)
            REMOVED=$(cat icons-diff.json | grep -o '"removed":[0-9]*' | head -1 | cut -d: -f2)
            MODIFIED=$(cat icons-diff.json | grep -o '"modified":[0-9]*' | head -1 | cut -d: -f2)
            HAS_CHANGES=$(cat icons-diff.json | grep -o '"hasChanges":true' | wc -l)

            echo "added=$ADDED" >> $GITHUB_OUTPUT
            echo "removed=$REMOVED" >> $GITHUB_OUTPUT
            echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
            echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        if: steps.compare.outputs.has_changes == '1' || !steps.compare.outputs.has_changes
        run: |
          node scripts/icons/generate-icon-release-notes.js

      # ========================================
      # Create/Update PR
      # ========================================

      - name: Create or update PR
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Read release notes
            let body = '## Icon Update\n\nNo detailed changes available.';
            try {
              body = fs.readFileSync('icons-release-notes.md', 'utf8');
            } catch (e) {
              console.log('No release notes file found');
            }

            const added = '${{ steps.compare.outputs.added }}' || '0';
            const removed = '${{ steps.compare.outputs.removed }}' || '0';
            const modified = '${{ steps.compare.outputs.modified }}' || '0';

            // Generate title
            const parts = [];
            if (parseInt(added) > 0) parts.push(`+${added} new`);
            if (parseInt(removed) > 0) parts.push(`-${removed} removed`);
            if (parseInt(modified) > 0) parts.push(`~${modified} modified`);

            const title = parts.length > 0
              ? `feat(icons): Update icons (${parts.join(', ')})`
              : 'feat(icons): Update icon assets';

            // Check for existing PR
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:figma-icons`,
              base: 'main',
              state: 'open',
            });

            if (pulls.length > 0) {
              // Update existing PR
              const pr = pulls[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: title,
                body: body,
              });
              console.log(`Updated PR #${pr.number}`);
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_url', pr.html_url);
            } else {
              // Create new PR
              const { data: newPr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                head: 'figma-icons',
                base: 'main',
              });
              console.log(`Created PR #${newPr.number}`);
              core.setOutput('pr_number', newPr.number);
              core.setOutput('pr_url', newPr.html_url);
            }

      # ========================================
      # Upload Artifacts
      # ========================================

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: icon-build-figma
          path: |
            packages/icons/dist/
            icons-diff.json
            icons-release-notes.md
          retention-days: 30

      # ========================================
      # Cleanup
      # ========================================

      - name: Cleanup baseline
        run: rm -rf dist-icons-old
