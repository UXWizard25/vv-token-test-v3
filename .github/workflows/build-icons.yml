# ============================================================================
# Icon Build Workflow
# ============================================================================
#
# Builds icon assets for all platforms when icons change.
# Triggers on push to main, develop, figma-icons, and claude/** branches.
#
# Outputs:
#   - @marioschmidt/design-system-icons (SVG package)
#   - @marioschmidt/design-system-icons-react (React package)
#   - Android Vector Drawables (de.bild.design:icons)
#   - iOS Asset Catalog (BildIcons SPM)
#
# ============================================================================

name: Build Icons

on:
  push:
    branches:
      - main
      - develop
      - figma-icons
      - 'claude/**'
    paths:
      - 'packages/icons/src/**'
      - 'scripts/icons/**'
      - 'build-config/icons/**'
      - 'packages/icons/svg/package.json'
      - 'packages/icons/react/package.json'
      - '.github/workflows/build-icons.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'packages/icons/src/**'
      - 'scripts/icons/**'
      - 'build-config/icons/**'
      - 'packages/icons/svg/package.json'
      - 'packages/icons/react/package.json'
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Force clean build (delete all icon dist folders)'
        required: false
        default: 'false'
        type: boolean

# Ensure only one build runs at a time per branch
concurrency:
  group: icons-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Icon Assets
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # Setup
      # ========================================

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ========================================
      # Clean (optional)
      # ========================================

      - name: Clean previous build
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          rm -rf packages/icons/svg/dist
          rm -rf packages/icons/react/dist
          rm -rf packages/icons/react/.src
          rm -rf packages/icons/android/src/main/res/drawable/*.xml
          rm -rf packages/icons/ios/Sources/BildIcons/Resources/Assets.xcassets/Icons/*.imageset

      # ========================================
      # Build
      # ========================================

      - name: Build icons
        id: build
        run: |
          echo "::group::Building icon assets"
          node scripts/icons/build-icons.js
          echo "::endgroup::"

          # Count generated files from new package locations
          SVG_COUNT=$(find packages/icons/svg/dist -name "*.svg" 2>/dev/null | wc -l || echo 0)
          REACT_COUNT=$(find packages/icons/react/dist -name "*.js" 2>/dev/null | wc -l || echo 0)
          ANDROID_COUNT=$(find packages/icons/android/src/main/res/drawable -name "*.xml" 2>/dev/null | wc -l || echo 0)
          IOS_COUNT=$(find packages/icons/ios/Sources/BildIcons/Resources/Assets.xcassets/Icons -name "*.imageset" -type d 2>/dev/null | wc -l || echo 0)

          echo "svg_count=$SVG_COUNT" >> $GITHUB_OUTPUT
          echo "react_count=$REACT_COUNT" >> $GITHUB_OUTPUT
          echo "android_count=$ANDROID_COUNT" >> $GITHUB_OUTPUT
          echo "ios_count=$IOS_COUNT" >> $GITHUB_OUTPUT

      # ========================================
      # Artifacts
      # ========================================

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: icon-assets
          path: |
            packages/icons/svg/dist/
            packages/icons/react/dist/
            packages/icons/android/src/main/res/
            packages/icons/ios/Sources/BildIcons/
          retention-days: 30
          if-no-files-found: warn

      # ========================================
      # Summary
      # ========================================

      - name: Create build summary
        run: |
          echo "## Icon Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Package | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| SVG | \`@marioschmidt/design-system-icons\` | ${{ steps.build.outputs.svg_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| React | \`@marioschmidt/design-system-icons-react\` | ${{ steps.build.outputs.react_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | \`de.bild.design:icons\` | ${{ steps.build.outputs.android_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | \`BildIcons\` (SPM) | ${{ steps.build.outputs.ios_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

      # ========================================
      # PR Comment (if applicable)
      # ========================================

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const svgCount = '${{ steps.build.outputs.svg_count }}';
            const reactCount = '${{ steps.build.outputs.react_count }}';
            const androidCount = '${{ steps.build.outputs.android_count }}';
            const iosCount = '${{ steps.build.outputs.ios_count }}';

            const body = `## ðŸŽ¨ Icon Build Complete

            | Platform | Package | Files |
            |----------|---------|-------|
            | ðŸŒ SVG | \`@marioschmidt/design-system-icons\` | ${svgCount} |
            | âš›ï¸ React | \`@marioschmidt/design-system-icons-react\` | ${reactCount} |
            | ðŸ¤– Android | \`de.bild.design:icons\` | ${androidCount} |
            | ðŸŽ iOS | \`BildIcons\` (SPM) | ${iosCount} |

            **Artifacts:** [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Icon Build Complete')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
