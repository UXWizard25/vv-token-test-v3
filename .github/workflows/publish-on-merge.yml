name: Publish Package on Merge

# Trigger: Only when design token source files change (not pipeline code)
on:
  push:
    branches:
      - main
    paths:
      - 'packages/tokens/src/**'
      - 'packages/components/src/**'

permissions:
  contents: write
  packages: write
  id-token: write

# Prevent race conditions: only one publish workflow runs at a time
# If a second merge happens while publishing, it waits until the first completes
concurrency:
  group: publish-main
  cancel-in-progress: false

jobs:
  publish:
    name: Build & Publish Package
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Git konfigurieren f√ºr Tagging
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # 3. Node.js Setup f√ºr npmjs.org
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      # 4. Dependencies installieren
      - name: Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci

      # 5. Letzten Tag ermitteln (f√ºr Baseline und Version)
      - name: Get Latest Tag
        id: latest_tag
        run: |
          # Hole letzten Token-Tag (v*.*.*, NICHT icons-v*)
          LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
            echo "No token tags found, using default: $LATEST_TAG"
          else
            echo "Latest token tag: $LATEST_TAG"
          fi

          # Entferne 'v' prefix
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "Current version: $CURRENT_VERSION"

          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      # 6. Erster Build (f√ºr Diff-Vergleich, mit aktueller Version)
      - name: Build Tokens for Comparison
        run: |
          echo "üé® Building tokens for comparison..."
          npm run build:tokens 2>&1 | tee build-output.log
          echo "‚úÖ Initial build complete"

      # 7. Baseline vom vorherigen Tag erstellen
      - name: Build Baseline from Previous Tag
        id: baseline
        run: |
          echo "üìä Building baseline for token comparison..."

          # Aktuellen dist speichern
          cp -r packages/tokens/dist/ dist-new/

          # Aktuelle Source-Datei speichern (f√ºr Rename-Detection)
          cp packages/tokens/src/bild-design-system-raw-data.json source-new.json
          echo "‚úÖ Saved current source file"

          # Vorherigen Tag f√ºr Baseline
          LATEST_TAG="${{ steps.latest_tag.outputs.tag }}"

          if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "v1.0.0" ]; then
            echo "Building baseline from $LATEST_TAG..."

            # Source-Datei vom vorherigen Tag holen (f√ºr Rename-Detection)
            git show "$LATEST_TAG:packages/tokens/src/bild-design-system-raw-data.json" > source-old.json 2>/dev/null || true
            if [ -f "source-old.json" ] && [ -s "source-old.json" ]; then
              echo "‚úÖ Saved baseline source file from $LATEST_TAG"
              echo "has_source_baseline=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Could not get baseline source file"
              echo "has_source_baseline=false" >> $GITHUB_OUTPUT
            fi

            # Source-Dateien vom vorherigen Tag holen
            git checkout "$LATEST_TAG" -- packages/tokens/src/ 2>/dev/null || true

            # Baseline bauen
            rm -rf packages/tokens/dist/
            npm run build:tokens 2>/dev/null || true

            if [ -d "packages/tokens/dist" ]; then
              mv packages/tokens/dist/ dist-old/
              echo "has_baseline=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Baseline built from $LATEST_TAG"
            else
              echo "has_baseline=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Could not build baseline"
            fi

            # Zur√ºck zum aktuellen Stand
            git checkout HEAD -- packages/tokens/src/ 2>/dev/null || true
          else
            echo "No previous tag found, skipping baseline"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            echo "has_source_baseline=false" >> $GITHUB_OUTPUT
          fi

          # dist-new zur√ºck zu packages/tokens/dist
          rm -rf packages/tokens/dist/
          mv dist-new/ packages/tokens/dist/

      # 8. Token-Diff generieren und Impact Level ermitteln
      - name: Generate Token Diff and Determine Impact
        id: diff
        run: |
          if [ "${{ steps.baseline.outputs.has_baseline }}" = "true" ] && [ -d "dist-old" ]; then
            echo "üîç Comparing token builds..."

            # Build compare command with optional source files for rename detection
            COMPARE_CMD="node scripts/tokens/compare-builds.js --old dist-old/ --new packages/tokens/dist/"

            if [ "${{ steps.baseline.outputs.has_source_baseline }}" = "true" ] && [ -f "source-old.json" ] && [ -f "source-new.json" ]; then
              echo "üìé Including source files for rename detection..."
              COMPARE_CMD="$COMPARE_CMD --source-old source-old.json --source-new source-new.json"
            fi

            COMPARE_CMD="$COMPARE_CMD --output dist-diff.json"
            eval $COMPARE_CMD

            # Impact Level aus Diff extrahieren
            IMPACT_LEVEL=$(node -p "require('./dist-diff.json').summary.impactLevel")
            echo "Impact level: $IMPACT_LEVEL"

            # Statistiken ausgeben
            TOKENS_ADDED=$(node -p "require('./dist-diff.json').summary.uniqueTokensAdded")
            TOKENS_MODIFIED=$(node -p "require('./dist-diff.json').summary.uniqueTokensModified")
            TOKENS_REMOVED=$(node -p "require('./dist-diff.json').summary.uniqueTokensRemoved")
            TOKENS_RENAMED=$(node -p "require('./dist-diff.json').summary.uniqueTokensRenamed || 0")

            echo "üìä Token Changes:"
            echo "   üü¢ Added: $TOKENS_ADDED"
            echo "   üü° Modified: $TOKENS_MODIFIED"
            echo "   üî¥ Removed: $TOKENS_REMOVED"
            echo "   üîÑ Renamed: $TOKENS_RENAMED"

            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "impact_level=$IMPACT_LEVEL" >> $GITHUB_OUTPUT
            echo "tokens_added=$TOKENS_ADDED" >> $GITHUB_OUTPUT
            echo "tokens_modified=$TOKENS_MODIFIED" >> $GITHUB_OUTPUT
            echo "tokens_removed=$TOKENS_REMOVED" >> $GITHUB_OUTPUT
            echo "tokens_renamed=$TOKENS_RENAMED" >> $GITHUB_OUTPUT
          else
            echo "No baseline available, using default impact level"
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "impact_level=minor" >> $GITHUB_OUTPUT
            echo "tokens_renamed=0" >> $GITHUB_OUTPUT
          fi

      # 9. Version Bump Type basierend auf Impact Level bestimmen
      - name: Determine Version Bump Type
        id: bump_type
        run: |
          IMPACT="${{ steps.diff.outputs.impact_level }}"

          echo "üéØ Determining version bump type for impact: $IMPACT"

          # Impact-basiertes Versioning:
          # - breaking (tokens removed) ‚Üí minor bump (1.0.x ‚Üí 1.1.0)
          # - moderate (tokens modified) ‚Üí patch bump (1.0.x ‚Üí 1.0.y)
          # - minor (tokens added) ‚Üí patch bump (1.0.x ‚Üí 1.0.y)
          # - none ‚Üí patch bump (for other changes like formatting)

          case "$IMPACT" in
            breaking)
              BUMP_TYPE="minor"
              echo "üî¥ Breaking changes detected ‚Üí minor version bump"
              ;;
            moderate)
              BUMP_TYPE="patch"
              echo "üü° Moderate changes detected ‚Üí patch version bump"
              ;;
            minor)
              BUMP_TYPE="patch"
              echo "üü¢ Minor changes detected ‚Üí patch version bump"
              ;;
            *)
              BUMP_TYPE="patch"
              echo "‚ö™ No significant changes ‚Üí patch version bump"
              ;;
          esac

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      # 10. Version erh√∂hen (basierend auf Impact)
      - name: Bump Version
        id: version
        run: |
          CURRENT_VERSION="${{ steps.latest_tag.outputs.version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"

          echo "üì¶ Bumping version: $CURRENT_VERSION ‚Üí $BUMP_TYPE"

          # Bump version in tokens package first
          cd packages/tokens
          npm version $CURRENT_VERSION --no-git-tag-version --allow-same-version
          npm version $BUMP_TYPE --no-git-tag-version
          cd ../..

          # Neue Version aus Tokens package lesen
          NEW_VERSION=$(node -p "require('./packages/tokens/package.json').version")
          echo "New version: $NEW_VERSION"

          # Sync all other packages to same version
          echo "üì¶ Syncing all packages to version $NEW_VERSION..."

          cd packages/components
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          cd ../..

          cd packages/react
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          cd ../..

          cd packages/vue
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          cd ../..

          echo "‚úÖ All 4 packages at version $NEW_VERSION"

          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      # 11. Finaler Build mit korrekter Version (f√ºr Headers)
      - name: Final Build with Correct Version
        id: build
        run: |
          echo "üé® Building with version ${{ steps.version.outputs.new }}..."
          npm run build:all 2>&1 | tee build-output.log

          # Extrahiere Build-Statistiken
          SUCCESSFUL_BUILDS=$(grep -oP 'Builds erfolgreich: \K\d+' build-output.log || echo "0")
          TOTAL_BUILDS=$(grep -oP 'Builds erfolgreich: \d+/\K\d+' build-output.log || echo "0")

          echo "successful_builds=$SUCCESSFUL_BUILDS" >> $GITHUB_OUTPUT
          echo "total_builds=$TOTAL_BUILDS" >> $GITHUB_OUTPUT

          if [ "$SUCCESSFUL_BUILDS" -eq "0" ]; then
            echo "‚ùå Build failed!"
            exit 1
          fi

          echo "‚úÖ Build successful: $SUCCESSFUL_BUILDS/$TOTAL_BUILDS"

      # 12. Package Inhalt validieren
      - name: Validate Package Contents
        run: |
          echo "üìã Validating package contents..."
          npm pack --dry-run

          echo ""
          echo "üìÅ Package will contain:"
          npm pack --dry-run 2>&1 | grep -E "npm notice.*B " | head -20 || true

      # 13. Package erstellen und Gr√∂√üe ermitteln
      - name: Create Package and Get Size
        id: package
        run: |
          echo "üì¶ Creating package..."
          npm pack

          # Ermittle Package-Gr√∂√üe
          PACKAGE_FILE=$(ls -t *.tgz | head -1)
          PACKAGE_SIZE=$(ls -lh "$PACKAGE_FILE" | awk '{print $5}')

          echo "package_file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "‚úÖ Package: $PACKAGE_FILE ($PACKAGE_SIZE)"

      # 14. Tag erstellen
      - name: Create Git Tag
        run: |
          TAG_NAME="v${{ steps.version.outputs.new }}"

          # Pr√ºfe ob Tag bereits existiert
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag $TAG_NAME already exists, skipping tag creation"
          else
            git tag "$TAG_NAME"
            echo "‚úÖ Created tag: $TAG_NAME"
          fi

      # 15. Push Tag
      - name: Push Tag
        run: |
          TAG_NAME="v${{ steps.version.outputs.new }}"

          # Pr√ºfe ob Tag remote existiert
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "‚ö†Ô∏è  Tag $TAG_NAME already exists on remote, skipping push"
          else
            git push origin "$TAG_NAME"
            echo "‚úÖ Pushed tag $TAG_NAME"
          fi

          echo "‚ÑπÔ∏è  Note: Version bump is not committed to main (avoids race conditions)"

      # 16. Packages ver√∂ffentlichen
      - name: Publish Tokens to npmjs.org
        run: |
          echo "üì¶ Publishing @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }} to npmjs.org..."
          npm publish -w @marioschmidt/design-system-tokens --access public
          echo "‚úÖ Tokens package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Components to npmjs.org
        run: |
          echo "üì¶ Publishing @marioschmidt/design-system-components@${{ steps.version.outputs.new }} to npmjs.org..."
          npm publish -w @marioschmidt/design-system-components --access public
          echo "‚úÖ Components package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish React Wrappers to npmjs.org
        run: |
          echo "üì¶ Publishing @marioschmidt/design-system-react@${{ steps.version.outputs.new }} to npmjs.org..."
          npm publish -w @marioschmidt/design-system-react --access public
          echo "‚úÖ React package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Vue Wrappers to npmjs.org
        run: |
          echo "üì¶ Publishing @marioschmidt/design-system-vue@${{ steps.version.outputs.new }} to npmjs.org..."
          npm publish -w @marioschmidt/design-system-vue --access public
          echo "‚úÖ Vue package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 17. Release Notes generieren (Diff bereits vorhanden)
      - name: Generate Release Notes
        id: release_notes
        run: |
          if [ "${{ steps.diff.outputs.has_diff }}" = "true" ] && [ -f "dist-diff.json" ]; then
            echo "üìù Generating token-based release notes..."
            node scripts/tokens/release-notes.js \
              --diff-file dist-diff.json \
              --format github-release \
              --version "${{ steps.version.outputs.new }}" \
              --successful-builds "${{ steps.build.outputs.successful_builds }}" \
              --total-builds "${{ steps.build.outputs.total_builds }}" \
              --package-size "${{ steps.package.outputs.package_size }}" \
              --output release-notes.md
          else
            echo "üìù Generating fallback release notes..."
            {
              echo "## üé® Design System v${{ steps.version.outputs.new }}"
              echo ""
              echo "### üì¶ Installation"
              echo ""
              echo '```bash'
              echo "# Design Tokens (CSS, JS, iOS, Android)"
              echo "npm install @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }}"
              echo ""
              echo "# Web Components (Stencil)"
              echo "npm install @marioschmidt/design-system-components@${{ steps.version.outputs.new }}"
              echo ""
              echo "# React Wrappers"
              echo "npm install @marioschmidt/design-system-react@${{ steps.version.outputs.new }}"
              echo ""
              echo "# Vue Wrappers"
              echo "npm install @marioschmidt/design-system-vue@${{ steps.version.outputs.new }}"
              echo '```'
              echo ""
              echo "### üìã Build Info"
              echo ""
              echo "- **Build Status:** ‚úÖ ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }} successful"
              echo "- **Package Size:** ${{ steps.package.outputs.package_size }}"
              echo "- **Version Bump:** ${{ steps.version.outputs.bump_type }} (based on token impact)"
              echo "- **Tokens:** CSS, SCSS, JavaScript, Swift, Android Compose, JSON"
              echo "- **Components:** Stencil Web Components"
              echo "- **Framework Wrappers:** React, Vue"
              echo ""
              echo "### üîó Links"
              echo ""
              echo "- [üìñ Documentation](https://github.com/${{ github.repository }}#readme)"
              echo "- [üì¶ Tokens on npm](https://www.npmjs.com/package/@marioschmidt/design-system-tokens)"
              echo "- [üì¶ Components on npm](https://www.npmjs.com/package/@marioschmidt/design-system-components)"
              echo "- [üì¶ React on npm](https://www.npmjs.com/package/@marioschmidt/design-system-react)"
              echo "- [üì¶ Vue on npm](https://www.npmjs.com/package/@marioschmidt/design-system-vue)"
            } > release-notes.md
          fi

          # Output f√ºr GitHub Release
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 18. GitHub Release erstellen
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: Release v${{ steps.version.outputs.new }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
          generate_release_notes: false

      # 19. Success Summary
      - name: Create Publish Summary
        run: |
          echo "## üöÄ Packages Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`@marioschmidt/design-system-tokens\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@marioschmidt/design-system-components\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@marioschmidt/design-system-react\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@marioschmidt/design-system-vue\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** \`${{ steps.version.outputs.current }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** \`${{ steps.version.outputs.new }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version Bump:** \`${{ steps.version.outputs.bump_type }}\` (based on impact: ${{ steps.diff.outputs.impact_level }})" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** npmjs.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Token Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Added | ${{ steps.diff.outputs.tokens_added || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Modified | ${{ steps.diff.outputs.tokens_modified || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Removed | ${{ steps.diff.outputs.tokens_removed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ Renamed | ${{ steps.diff.outputs.tokens_renamed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Design Tokens" >> $GITHUB_STEP_SUMMARY
          echo "npm install @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Web Components (Stencil)" >> $GITHUB_STEP_SUMMARY
          echo "npm install @marioschmidt/design-system-components@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# React Wrappers" >> $GITHUB_STEP_SUMMARY
          echo "npm install @marioschmidt/design-system-react@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Vue Wrappers" >> $GITHUB_STEP_SUMMARY
          echo "npm install @marioschmidt/design-system-vue@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ Tokens on npm](https://www.npmjs.com/package/@marioschmidt/design-system-tokens)" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ Components on npm](https://www.npmjs.com/package/@marioschmidt/design-system-components)" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ React on npm](https://www.npmjs.com/package/@marioschmidt/design-system-react)" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ Vue on npm](https://www.npmjs.com/package/@marioschmidt/design-system-vue)" >> $GITHUB_STEP_SUMMARY
          echo "- [üìã Release Notes](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new }})" >> $GITHUB_STEP_SUMMARY
          echo "- [üé® Pull Requests](https://github.com/${{ github.repository }}/pulls?q=is%3Apr+is%3Amerged)" >> $GITHUB_STEP_SUMMARY

      # 20. Bei Fehler benachrichtigen
      - name: Notify on Failure
        if: failure()
        run: |
          echo "## ‚ùå Package Publishing Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Intended Version:** \`${{ steps.version.outputs.new }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Details" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for detailed error information." >> $GITHUB_STEP_SUMMARY
