name: Publish Package on Merge

# Trigger: Only when design token source files change (not pipeline code)
on:
  push:
    branches:
      - main
    paths:
      - 'src/design-tokens/**'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  publish:
    name: Build & Publish Package
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Git konfigurieren f√ºr Tagging
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # 3. Node.js Setup f√ºr npmjs.org
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      # 4. Dependencies installieren
      - name: Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci

      # 5. Version erh√∂hen (Patch)
      - name: Bump Version (Patch)
        id: version
        run: |
          # Hole letzten Token-Tag (v*.*.*, NICHT icons-v*)
          # Filtere explizit f√ºr Tags die mit 'v' beginnen und NICHT 'icons-v'
          LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
            echo "No token tags found, using default: $LATEST_TAG"
          else
            echo "Latest token tag: $LATEST_TAG"
          fi

          # Entferne 'v' prefix
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "Current version: $CURRENT_VERSION"

          # Setze Version in package.json (tempor√§r, nur f√ºr Build)
          npm version $CURRENT_VERSION --no-git-tag-version --allow-same-version

          # Erh√∂he Patch-Version
          npm version patch --no-git-tag-version

          # Neue Version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"

          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 6. Token Build durchf√ºhren
      - name: Build Design Tokens
        id: build
        run: |
          echo "üé® Building design tokens..."
          npm run build 2>&1 | tee build-output.log

          # Extrahiere Build-Statistiken
          SUCCESSFUL_BUILDS=$(grep -oP 'Builds erfolgreich: \K\d+' build-output.log || echo "0")
          TOTAL_BUILDS=$(grep -oP 'Builds erfolgreich: \d+/\K\d+' build-output.log || echo "0")

          echo "successful_builds=$SUCCESSFUL_BUILDS" >> $GITHUB_OUTPUT
          echo "total_builds=$TOTAL_BUILDS" >> $GITHUB_OUTPUT

          if [ "$SUCCESSFUL_BUILDS" -eq "0" ]; then
            echo "‚ùå Build failed!"
            exit 1
          fi

          echo "‚úÖ Build successful: $SUCCESSFUL_BUILDS/$TOTAL_BUILDS"

      # 7. Package Inhalt validieren
      - name: Validate Package Contents
        run: |
          echo "üìã Validating package contents..."
          npm pack --dry-run

          echo ""
          echo "üìÅ Package will contain:"
          npm pack --dry-run 2>&1 | grep -E "npm notice.*B " | head -20 || true

      # 8. Package erstellen und Gr√∂√üe ermitteln
      - name: Create Package and Get Size
        id: package
        run: |
          echo "üì¶ Creating package..."
          npm pack

          # Ermittle Package-Gr√∂√üe
          PACKAGE_FILE=$(ls -t *.tgz | head -1)
          PACKAGE_SIZE=$(ls -lh "$PACKAGE_FILE" | awk '{print $5}')

          echo "package_file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "‚úÖ Package: $PACKAGE_FILE ($PACKAGE_SIZE)"

      # 9. Tag erstellen (Version ist nur lokal f√ºr Publishing)
      - name: Create Git Tag
        run: |
          TAG_NAME="v${{ steps.version.outputs.new }}"

          # Pr√ºfe ob Tag bereits existiert
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag $TAG_NAME already exists, skipping tag creation"
          else
            git tag "$TAG_NAME"
            echo "‚úÖ Created tag: $TAG_NAME"
          fi

      # 10. Push Tag (Version Bump wird nicht committed, nur Tag)
      - name: Push Tag
        run: |
          TAG_NAME="v${{ steps.version.outputs.new }}"

          # Pr√ºfe ob Tag remote existiert
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "‚ö†Ô∏è  Tag $TAG_NAME already exists on remote, skipping push"
          else
            git push origin "$TAG_NAME"
            echo "‚úÖ Pushed tag $TAG_NAME"
          fi

          echo "‚ÑπÔ∏è  Note: Version bump is not committed to main (avoids race conditions)"

      # 11. Package ver√∂ffentlichen
      - name: Publish to npmjs.org
        run: |
          echo "üì¶ Publishing @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }} to npmjs.org..."
          npm publish
          echo "‚úÖ Package published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 12. Build Baseline f√ºr Vergleich (vom vorherigen Tag)
      - name: Build Baseline for Comparison
        id: baseline
        run: |
          echo "üìä Building baseline for token comparison..."

          # Aktuellen dist speichern
          mv dist/ dist-new/

          # Vorherigen Tag finden
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Building baseline from $PREVIOUS_TAG..."

            # Zu vorherigem Tag wechseln und bauen
            git checkout "$PREVIOUS_TAG" -- src/design-tokens/ 2>/dev/null || true
            npm run build 2>/dev/null || true

            if [ -d "dist" ]; then
              mv dist/ dist-old/
              echo "has_baseline=true" >> $GITHUB_OUTPUT
            else
              echo "has_baseline=false" >> $GITHUB_OUTPUT
            fi

            # Zur√ºck zum aktuellen Stand
            git checkout HEAD -- src/design-tokens/ 2>/dev/null || true
          else
            echo "No previous tag found, skipping baseline"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
          fi

          # dist-new zur√ºck zu dist
          mv dist-new/ dist/

      # 13. Token-Diff generieren
      - name: Generate Token Diff
        id: diff
        run: |
          if [ "${{ steps.baseline.outputs.has_baseline }}" = "true" ] && [ -d "dist-old" ]; then
            echo "üîç Comparing token builds..."
            node scripts/compare-dist-builds.js \
              --old dist-old/ \
              --new dist/ \
              --output dist-diff.json

            echo "has_diff=true" >> $GITHUB_OUTPUT
          else
            echo "No baseline available, skipping diff"
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

      # 14. Release Notes generieren
      - name: Generate Release Notes
        id: release_notes
        run: |
          if [ "${{ steps.diff.outputs.has_diff }}" = "true" ] && [ -f "dist-diff.json" ]; then
            echo "üìù Generating token-based release notes..."
            node scripts/generate-release-notes.js \
              --diff-file dist-diff.json \
              --format github-release \
              --version "${{ steps.version.outputs.new }}" \
              --successful-builds "${{ steps.build.outputs.successful_builds }}" \
              --total-builds "${{ steps.build.outputs.total_builds }}" \
              --package-size "${{ steps.package.outputs.package_size }}" \
              --output release-notes.md
          else
            echo "üìù Generating fallback release notes..."
            {
              echo "## üé® Design Tokens v${{ steps.version.outputs.new }}"
              echo ""
              echo "### üì¶ Installation"
              echo ""
              echo '```bash'
              echo "npm install @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }}"
              echo '```'
              echo ""
              echo "### üìã Build Info"
              echo ""
              echo "- **Build Status:** ‚úÖ ${{ steps.build.outputs.successful_builds }}/${{ steps.build.outputs.total_builds }} successful"
              echo "- **Package Size:** ${{ steps.package.outputs.package_size }}"
              echo "- **Formats:** CSS, SCSS, JavaScript, Swift, Android XML, Flutter Dart, JSON"
              echo ""
              echo "### üîó Links"
              echo ""
              echo "- [üìñ Documentation](https://github.com/${{ github.repository }}#readme)"
              echo "- [üì¶ npm Package](https://www.npmjs.com/package/@marioschmidt/design-system-tokens)"
            } > release-notes.md
          fi

          # Output f√ºr GitHub Release
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 15. GitHub Release erstellen
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: Release v${{ steps.version.outputs.new }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
          generate_release_notes: false

      # 16. Success Summary
      - name: Create Publish Summary
        run: |
          echo "## üöÄ Package Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`@marioschmidt/design-system-tokens\`" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** \`${{ steps.version.outputs.current }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** \`${{ steps.version.outputs.new }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** npmjs.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @marioschmidt/design-system-tokens@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ View on npmjs.org](https://www.npmjs.com/package/@marioschmidt/design-system-tokens)" >> $GITHUB_STEP_SUMMARY
          echo "- [üìã Release Notes](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new }})" >> $GITHUB_STEP_SUMMARY
          echo "- [üé® Pull Requests](https://github.com/${{ github.repository }}/pulls?q=is%3Apr+is%3Amerged)" >> $GITHUB_STEP_SUMMARY

      # 17. Bei Fehler benachrichtigen
      - name: Notify on Failure
        if: failure()
        run: |
          echo "## ‚ùå Package Publishing Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Intended Version:** \`${{ steps.version.outputs.new }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Details" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for detailed error information." >> $GITHUB_STEP_SUMMARY
