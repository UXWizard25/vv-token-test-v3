# ============================================================================
# Publish Icons on Merge
# ============================================================================
#
# Publishes icon packages when icon changes are merged to main.
#
# Packages published:
#   - @marioschmidt/design-system-icons (SVG) → npm
#   - @marioschmidt/design-system-icons-react (React) → npm
#   - de.bild.design:icons (Android) → GitHub Packages (Maven)
#   - BildIcons (iOS) → via git tag (SPM)
#
# Workflow:
#   1. Detect icon changes in merge commit
#   2. Bump version in all package files (synchronized: npm + gradle)
#   3. Build fresh icon assets for all platforms
#   4. Publish npm packages (SVG, React)
#   5. Publish Android package to GitHub Packages (Maven)
#   6. Create GitHub release (triggers iOS SPM update)
#
# ============================================================================

name: Publish Icons

on:
  push:
    branches:
      - main
    paths:
      - 'packages/icons/src/**'
      - 'build-config/icons/**'
      - 'scripts/icons/**'

# Prevent concurrent publishes
concurrency:
  group: icons-publish
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  publish:
    name: Publish Icon Packages
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # Setup
      # ========================================

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Java (for Android)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: npm ci

      # ========================================
      # Version Bump (synchronized across packages)
      # ========================================

      - name: Bump version
        id: version
        run: |
          # Read current version from SVG package (source of truth)
          CURRENT_VERSION=$(cat packages/icons/svg/package.json | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Bump patch version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          # Check if tag already exists, keep incrementing until we find an unused version
          while git tag -l "icons-v$NEW_VERSION" | grep -q "icons-v$NEW_VERSION"; do
            echo "Tag icons-v$NEW_VERSION already exists, incrementing..."
            NEW_PATCH=$((NEW_PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          done

          echo "New version: $NEW_VERSION"

          # Update all package files (synchronized versions)
          # npm packages
          sed -i "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" packages/icons/svg/package.json
          sed -i "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" packages/icons/react/package.json
          # Android gradle.properties
          sed -i "s/^VERSION=.*/VERSION=$NEW_VERSION/" packages/icons/android/gradle.properties

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "previous_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      # ========================================
      # Build
      # ========================================

      - name: Build icons
        run: |
          echo "::group::Building icon assets"
          node scripts/icons/build-icons.js
          echo "::endgroup::"

      - name: Count icons
        id: count
        run: |
          SVG_COUNT=$(find packages/icons/svg/dist -name "*.svg" 2>/dev/null | wc -l || echo 0)
          REACT_COUNT=$(find packages/icons/react/dist -name "*.js" 2>/dev/null | wc -l || echo 0)
          ANDROID_COUNT=$(find packages/icons/android/src/main/res/drawable -name "*.xml" 2>/dev/null | wc -l || echo 0)
          IOS_COUNT=$(find packages/icons/ios/Sources/BildIcons/Resources/Assets.xcassets/Icons -name "*.imageset" -type d 2>/dev/null | wc -l || echo 0)

          echo "svg_count=$SVG_COUNT" >> $GITHUB_OUTPUT
          echo "react_count=$REACT_COUNT" >> $GITHUB_OUTPUT
          echo "android_count=$ANDROID_COUNT" >> $GITHUB_OUTPUT
          echo "ios_count=$IOS_COUNT" >> $GITHUB_OUTPUT
          echo "count=$SVG_COUNT" >> $GITHUB_OUTPUT

      # ========================================
      # Validate
      # ========================================

      - name: Validate packages
        run: |
          echo "::group::Validating package contents"

          # Check required directories exist
          [ -d "packages/icons/svg/dist" ] || (echo "Missing packages/icons/svg/dist" && exit 1)
          [ -d "packages/icons/react/dist" ] || (echo "Missing packages/icons/react/dist" && exit 1)
          [ -d "packages/icons/android/src/main/res/drawable" ] || (echo "Missing packages/icons/android/src/main/res/drawable" && exit 1)
          [ -d "packages/icons/ios/Sources/BildIcons/Resources/Assets.xcassets/Icons" ] || (echo "Missing packages/icons/ios assets" && exit 1)

          # Check for at least one icon
          SVG_COUNT=$(find packages/icons/svg/dist -name "*.svg" | wc -l)
          if [ "$SVG_COUNT" -eq 0 ]; then
            echo "No SVG icons found - skipping publish"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found $SVG_COUNT icons"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      # ========================================
      # Publish npm packages
      # ========================================

      - name: Publish SVG package to npm
        if: steps.count.outputs.count != '0'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing @marioschmidt/design-system-icons..."
          npm publish -w @marioschmidt/design-system-icons --access public || echo "SVG package publish failed or already exists"

      - name: Publish React package to npm
        if: steps.count.outputs.count != '0'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing @marioschmidt/design-system-icons-react..."
          npm publish -w @marioschmidt/design-system-icons-react --access public || echo "React package publish failed or already exists"

      # ========================================
      # Publish Android package
      # ========================================

      - name: Publish Android package to Maven
        if: steps.count.outputs.android_count != '0'
        working-directory: packages/icons/android
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Publishing de.bild.design:icons to GitHub Packages..."
          # Generate gradle wrapper if missing (first-time setup)
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "Generating Gradle wrapper..."
            gradle wrapper --gradle-version=8.5
          fi
          chmod +x gradlew
          ./gradlew publish -PVERSION=${{ steps.version.outputs.version }} --no-daemon

      # ========================================
      # Commit & Tag
      # ========================================

      - name: Commit version bump
        if: steps.count.outputs.count != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all versioned files (npm + gradle)
          git add packages/icons/svg/package.json packages/icons/react/package.json packages/icons/android/gradle.properties
          # Also add gradle wrapper if it was generated
          git add packages/icons/android/gradle/wrapper/ packages/icons/android/gradlew packages/icons/android/gradlew.bat 2>/dev/null || true
          git commit -m "chore(icons): bump version to ${{ steps.version.outputs.version }}" || true
          git push || true

      - name: Create release tag
        if: steps.count.outputs.count != '0'
        run: |
          TAG="icons-v${{ steps.version.outputs.version }}"
          git tag -a "$TAG" -m "Icon release ${{ steps.version.outputs.version }}"
          git push origin "$TAG" || true

      # ========================================
      # GitHub Release
      # ========================================

      - name: Create GitHub Release
        if: steps.count.outputs.count != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const svgCount = '${{ steps.count.outputs.svg_count }}';
            const reactCount = '${{ steps.count.outputs.react_count }}';
            const androidCount = '${{ steps.count.outputs.android_count }}';
            const iosCount = '${{ steps.count.outputs.ios_count }}';

            const body = `## Icon Packages v${version}

            ### Installation

            **npm (SVG + React):**
            \`\`\`bash
            npm install @marioschmidt/design-system-icons@${version}
            npm install @marioschmidt/design-system-icons-react@${version}
            \`\`\`

            **Android (Maven via GitHub Packages):**
            \`\`\`kotlin
            // settings.gradle.kts
            dependencyResolutionManagement {
                repositories {
                    maven {
                        url = uri("https://maven.pkg.github.com/UXWizard25/bild-design-system")
                        credentials {
                            username = providers.gradleProperty("gpr.user").get()
                            password = providers.gradleProperty("gpr.token").get()
                        }
                    }
                }
            }

            // build.gradle.kts
            dependencies {
                implementation("de.bild.design:icons:${version}")
            }
            \`\`\`

            **iOS (Swift Package Manager):**
            Add \`https://github.com/UXWizard25/bild-design-system.git\` in Xcode with tag \`icons-v${version}\`

            ### Platform Contents
            | Platform | Package | Count |
            |----------|---------|-------|
            | SVG | \`@marioschmidt/design-system-icons\` | ${svgCount} |
            | React | \`@marioschmidt/design-system-icons-react\` | ${reactCount} |
            | Android | \`de.bild.design:icons\` | ${androidCount} |
            | iOS | \`BildIcons\` (SPM) | ${iosCount} |

            ### Usage

            **React:**
            \`\`\`tsx
            import { IconAdd, IconMenu } from '@marioschmidt/design-system-icons-react';

            <IconAdd size={24} />
            <IconMenu aria-label="Open menu" />
            \`\`\`

            **Android (Jetpack Compose):**
            \`\`\`kotlin
            import de.bild.design.icons.BildIcons
            import de.bild.design.icons.BildIcon

            BildIcon(BildIcons.Add, contentDescription = "Add")
            \`\`\`

            **Android (XML):**
            \`\`\`xml
            <ImageView
                android:src="@drawable/ic_add"
                app:tint="?attr/colorOnSurface" />
            \`\`\`

            **iOS (SwiftUI):**
            \`\`\`swift
            import BildIcons

            BildIcon.add.icon(size: .md)
            \`\`\`
            `;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `icons-v${version}`,
              name: `Icons v${version}`,
              body: body,
              draft: false,
              prerelease: false,
            });

      # ========================================
      # Upload Artifacts
      # ========================================

      - name: Upload release artifacts
        if: steps.count.outputs.count != '0'
        uses: actions/upload-artifact@v6
        with:
          name: icon-release-${{ steps.version.outputs.version }}
          path: |
            packages/icons/svg/dist/
            packages/icons/react/dist/
            packages/icons/android/src/main/res/
            packages/icons/ios/Sources/BildIcons/
          retention-days: 90
